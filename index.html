import streamlit as st
import pandas as pd
import random
import datetime

# ãƒšãƒ¼ã‚¸è¨­å®š
st.set_page_config(page_title="AIçŒ®ç«‹ã‚·ã‚§ãƒ•", layout="wide")

# --- ãƒ‡ãƒ¼ã‚¿ã®åˆæœŸåŒ–ï¼ˆåˆå›èµ·å‹•æ™‚ã®ã¿å®Ÿè¡Œï¼‰ ---
if 'inventory' not in st.session_state:
    # åˆæœŸåœ¨åº«ãƒ‡ãƒ¼ã‚¿
    st.session_state.inventory = pd.DataFrame({
        'é£Ÿæå': ['è±šãƒãƒ©è‚‰', 'é¶ã‚‚ã‚‚è‚‰', 'ã‚­ãƒ£ãƒ™ãƒ„', 'ç‰ã­ã', 'äººå‚', 'ã˜ã‚ƒãŒã„ã‚‚', 'åµ', 'è±†è…', 'ã‚‚ã‚„ã—', 'ã²ãè‚‰'],
        'åœ¨åº«ã‚ã‚Š': [True, False, True, True, False, False, True, True, False, False],
        'ã‚«ãƒ†ã‚´ãƒª': ['è‚‰', 'è‚‰', 'é‡èœ', 'é‡èœ', 'é‡èœ', 'é‡èœ', 'åµãƒ»å¤§è±†', 'åµãƒ»å¤§è±†', 'é‡èœ', 'è‚‰']
    })

if 'recipes' not in st.session_state:
    # åˆæœŸãƒ¬ã‚·ãƒ”ãƒ‡ãƒ¼ã‚¿ï¼ˆ4è»¸è©•ä¾¡ä»˜ãï¼‰
    st.session_state.recipes = [
        {
            "name": "å›é‹è‚‰",
            "ingredients": ["è±šãƒãƒ©è‚‰", "ã‚­ãƒ£ãƒ™ãƒ„", "ãƒ”ãƒ¼ãƒãƒ³"],
            "taste": 5,        # 5æ®µéš
            "effort": "æ™®é€š",  # æ¥½ã¡ã‚“/æ™®é€š/æ‰‹é–“
            "cost": "æ™®é€š",    # ç¯€ç´„/æ™®é€š/è´…æ²¢
            "frequency": "æœˆ2-3å›", # é »åº¦
            "last_eaten": None
        },
        {
            "name": "è‚‰ã˜ã‚ƒãŒ",
            "ingredients": ["è±šãƒãƒ©è‚‰", "ã˜ã‚ƒãŒã„ã‚‚", "ç‰ã­ã", "äººå‚"],
            "taste": 4,
            "effort": "æ‰‹é–“",
            "cost": "æ™®é€š",
            "frequency": "æœˆ1å›",
            "last_eaten": None
        },
        {
            "name": "è¦ªå­ä¸¼",
            "ingredients": ["é¶ã‚‚ã‚‚è‚‰", "åµ", "ç‰ã­ã"],
            "taste": 5,
            "effort": "æ¥½ã¡ã‚“",
            "cost": "ç¯€ç´„",
            "frequency": "é€±1å›ä»¥ä¸Š",
            "last_eaten": None
        },
        {
            "name": "é‡èœç‚’ã‚",
            "ingredients": ["è±šãƒãƒ©è‚‰", "ã‚­ãƒ£ãƒ™ãƒ„", "ã‚‚ã‚„ã—", "äººå‚"],
            "taste": 3,
            "effort": "æ¥½ã¡ã‚“",
            "cost": "ç¯€ç´„",
            "frequency": "é€±1å›ä»¥ä¸Š",
            "last_eaten": None
        },
        {
            "name": "éº»å©†è±†è…",
            "ingredients": ["ã²ãè‚‰", "è±†è…", "ãƒã‚®"],
            "taste": 4,
            "effort": "æ™®é€š",
            "cost": "ç¯€ç´„",
            "frequency": "æœˆ2-3å›",
            "last_eaten": None
        },
        {
            "name": "ãƒã‚­ãƒ³ã‚½ãƒ†ãƒ¼",
            "ingredients": ["é¶ã‚‚ã‚‚è‚‰", "ãƒ–ãƒ­ãƒƒã‚³ãƒªãƒ¼"],
            "taste": 5,
            "effort": "æ™®é€š",
            "cost": "æ™®é€š",
            "frequency": "æœˆ2-3å›",
            "last_eaten": None
        },
        {
            "name": "è±šå¹³ç„¼ã",
            "ingredients": ["è±šãƒãƒ©è‚‰", "åµ", "ã‚­ãƒ£ãƒ™ãƒ„"],
            "taste": 4,
            "effort": "æ¥½ã¡ã‚“",
            "cost": "ç¯€ç´„",
            "frequency": "é€±1å›ä»¥ä¸Š",
            "last_eaten": None
        }
    ]

if 'weekly_menu' not in st.session_state:
    st.session_state.weekly_menu = {}

# --- é–¢æ•°å®šç¾© ---

def get_inventory_list():
    """åœ¨åº«ã‚ã‚Šã®é£Ÿæãƒªã‚¹ãƒˆã‚’è¿”ã™"""
    df = st.session_state.inventory
    return df[df['åœ¨åº«ã‚ã‚Š']]['é£Ÿæå'].tolist()

def calculate_score(recipe, current_inventory, is_weekend):
    """ãƒ¬ã‚·ãƒ”ã®æ¨å¥¨ã‚¹ã‚³ã‚¢ã‚’è¨ˆç®—ã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯"""
    score = 0
    
    # 1. åœ¨åº«æ¶ˆåŒ–ãƒœãƒ¼ãƒŠã‚¹ (åœ¨åº«ã«ã‚ã‚‹é£Ÿæã‚’ä½¿ã†ã»ã©é«˜å¾—ç‚¹)
    match_count = sum(1 for item in recipe['ingredients'] if item in current_inventory)
    score += match_count * 20 
    
    # 2. å‘³ã®å¥½ã¿
    score += recipe['taste'] * 10
    
    # 3. æ‰‹é–“ã¨æ›œæ—¥ã®ãƒãƒƒãƒãƒ³ã‚°
    if not is_weekend: # å¹³æ—¥
        if recipe['effort'] == "æ¥½ã¡ã‚“":
            score += 30
        elif recipe['effort'] == "æ‰‹é–“":
            score -= 50 # å¹³æ—¥ã«æ‰‹é–“ã®ã‹ã‹ã‚‹æ–™ç†ã¯é¿ã‘ã‚‹
    else: # ä¼‘æ—¥
        if recipe['effort'] == "æ‰‹é–“":
            score += 10 # ä¼‘æ—¥ã¯å°‘ã—å‡ã£ãŸã‚‚ã®ã§ã‚‚OK
        if recipe['cost'] == "è´…æ²¢":
            score += 20 # ä¼‘æ—¥ã¯è´…æ²¢OK
            
    # 4. é »åº¦åˆ¶å¾¡ (ç°¡æ˜“ç‰ˆ)
    if recipe['frequency'] == "äºŒåº¦ã¨ææ¡ˆã—ãªã„":
        score = -999
        
    return score

def generate_menu():
    """1é€±é–“åˆ†ã®çŒ®ç«‹ã‚’ç”Ÿæˆã™ã‚‹"""
    days = ["æœˆ", "ç«", "æ°´", "æœ¨", "é‡‘", "åœŸ", "æ—¥"]
    inventory = get_inventory_list()
    menu = {}
    
    # ãƒ¬ã‚·ãƒ”ãƒªã‚¹ãƒˆã®ã‚³ãƒ”ãƒ¼ã‚’ä½¿ç”¨
    available_recipes = st.session_state.recipes.copy()
    
    for i, day in enumerate(days):
        is_weekend = (day in ["åœŸ", "æ—¥"])
        
        # ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°
        for r in available_recipes:
            r['score'] = calculate_score(r, inventory, is_weekend)
            
        # ã‚¹ã‚³ã‚¢é †ã«ã‚½ãƒ¼ãƒˆã—ã¦ã€ä¸Šä½ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ æ€§ã‚’æŒãŸã›ã¦é¸æŠ
        available_recipes.sort(key=lambda x: x['score'], reverse=True)
        
        # ä¸Šä½3ã¤ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã«é¸ã¶ï¼ˆæ¯å›åŒã˜ã«ãªã‚‰ãªã„ã‚ˆã†ã«ï¼‰
        if available_recipes:
            candidates = available_recipes[:3]
            selected = random.choice(candidates)
            menu[day] = selected
            
            # é¸ã°ã‚ŒãŸãƒ¬ã‚·ãƒ”ã¯ãƒªã‚¹ãƒˆã‹ã‚‰å¤–ã™ï¼ˆ1é€±é–“ã§é‡è¤‡ã—ãªã„ã‚ˆã†ã«ã™ã‚‹å ´åˆï¼‰
            # é‡è¤‡OKãªã‚‰ã“ã®è¡Œã‚’ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ
            available_recipes.remove(selected) 
    
    st.session_state.weekly_menu = menu

# --- UIæ§‹ç¯‰ ---

st.title("ğŸ³ AIçŒ®ç«‹ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼")

# ã‚¿ãƒ–ã®ä½œæˆ
tab1, tab2, tab3, tab4 = st.tabs(["ğŸ  å†·è”µåº«ç®¡ç†", "ğŸ“… 1é€±é–“çŒ®ç«‹", "ğŸ›’ è²·ã„ç‰©ãƒªã‚¹ãƒˆ", "ğŸ“ ãƒ¬ã‚·ãƒ”ç™»éŒ²"])

# --- Tab 1: å†·è”µåº«ç®¡ç† ---
with tab1:
    st.header("ç¾åœ¨ã®å†·è”µåº«ã®ä¸­èº«")
    st.caption("ã‚ã‚‹ã‚‚ã®ã ã‘ãƒã‚§ãƒƒã‚¯ï¼ˆâœ…ï¼‰ã‚’å…¥ã‚Œã¦ãã ã•ã„")
    
    # ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã‚¨ãƒ‡ã‚£ã‚¿ã§ON/OFFåˆ‡ã‚Šæ›¿ãˆ
    edited_df = st.data_editor(
        st.session_state.inventory,
        column_config={
            "åœ¨åº«ã‚ã‚Š": st.column_config.CheckboxColumn(
                "åœ¨åº«ã‚¹ã‚¤ãƒƒãƒ",
                help="å†·è”µåº«ã«ã‚ã‚‹å ´åˆã¯ãƒã‚§ãƒƒã‚¯",
                default=False,
            )
        },
        disabled=["é£Ÿæå", "ã‚«ãƒ†ã‚´ãƒª"],
        hide_index=True,
        use_container_width=True
    )
    
    # å¤‰æ›´ã‚’ä¿å­˜
    if not edited_df.equals(st.session_state.inventory):
        st.session_state.inventory = edited_df
        st.success("åœ¨åº«æƒ…å ±ã‚’æ›´æ–°ã—ã¾ã—ãŸï¼")

# --- Tab 2: 1é€±é–“çŒ®ç«‹ ---
with tab2:
    st.header("ä»Šé€±ã®ææ¡ˆãƒ¡ãƒ‹ãƒ¥ãƒ¼")
    
    col1, col2 = st.columns([1, 3])
    with col1:
        if st.button("ğŸ”„ çŒ®ç«‹ã‚’ç”Ÿæˆã™ã‚‹", type="primary"):
            generate_menu()
            st.success("ä½œæˆã—ã¾ã—ãŸï¼")
    
    if st.session_state.weekly_menu:
        for day, recipe in st.session_state.weekly_menu.items():
            with st.container():
                st.markdown(f"### {day}æ›œæ—¥ï¼š {recipe['name']}")
                
                # è©³ç´°æƒ…å ±ã®è¡¨ç¤º
                c1, c2, c3, c4 = st.columns(4)
                c1.write(f"â¤ï¸ å‘³: {'â˜…'*recipe['taste']}")
                c2.write(f"ğŸ”ª æ‰‹é–“: {recipe['effort']}")
                c3.write(f"ğŸ’° ã‚³ã‚¹ãƒˆ: {recipe['cost']}")
                
                # é£Ÿæãƒãƒƒãƒãƒ³ã‚°è¡¨ç¤º
                stock_items = get_inventory_list()
                ingredients_display = []
                for ing in recipe['ingredients']:
                    if ing in stock_items:
                        ingredients_display.append(f"âœ…{ing}") # åœ¨åº«ã‚ã‚Š
                    else:
                        ingredients_display.append(f"âŒ{ing}") # åœ¨åº«ãªã—
                
                st.write(f"é£Ÿæ: {', '.join(ingredients_display)}")
                st.divider()
    else:
        st.info("ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦çŒ®ç«‹ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚")

# --- Tab 3: è²·ã„ç‰©ãƒªã‚¹ãƒˆ ---
with tab3:
    st.header("å¿…è¦ãªè²·ã„ç‰©ãƒªã‚¹ãƒˆ")
    
    if st.session_state.weekly_menu:
        needed_ingredients = {} # {é£Ÿæå: å›æ•°}
        stock_items = get_inventory_list()
        
        # é›†è¨ˆ
        for day, recipe in st.session_state.weekly_menu.items():
            for ing in recipe['ingredients']:
                if ing not in stock_items:
                    if ing in needed_ingredients:
                        needed_ingredients[ing]['count'] += 1
                        needed_ingredients[ing]['days'].append(day)
                    else:
                        needed_ingredients[ing] = {'count': 1, 'days': [day]}
        
        if needed_ingredients:
            st.write("åœ¨åº«ã«ãªãã€ä»Šé€±å¿…è¦ãªé£Ÿæã§ã™ï¼š")
            
            shop_data = []
            for name, info in needed_ingredients.items():
                shop_data.append({
                    "è²·ã†ã‚‚ã®": name,
                    "å¿…è¦å›æ•°": f"{info['count']}å›",
                    "ä½¿ã†æ›œæ—¥": ", ".join(info['days'])
                })
            
            st.table(pd.DataFrame(shop_data))
            
            if st.button("è²·ã„ç‰©ã‚’å®Œäº†ã™ã‚‹ï¼ˆåœ¨åº«ã«è¿½åŠ ï¼‰"):
                # è²·ã„ç‰©ãƒªã‚¹ãƒˆã«ã‚ã‚‹ã‚‚ã®ã‚’ã™ã¹ã¦åœ¨åº«ONã«ã™ã‚‹å‡¦ç†
                for index, row in st.session_state.inventory.iterrows():
                    if row['é£Ÿæå'] in needed_ingredients:
                        st.session_state.inventory.at[index, 'åœ¨åº«ã‚ã‚Š'] = True
                st.experimental_rerun()
                
        else:
            st.success("è²·ã„ç‰©ã¯ä¸è¦ã§ã™ï¼ã™ã¹ã¦ã®é£ŸæãŒæƒã£ã¦ã„ã¾ã™ã€‚")
    else:
        st.warning("ã¾ãšã¯ã€Œ1é€±é–“çŒ®ç«‹ã€ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚")

# --- Tab 4: ãƒ¬ã‚·ãƒ”ç™»éŒ² ---
with tab4:
    st.header("æ–°ã—ã„ãƒ¬ã‚·ãƒ”ã®ç™»éŒ²")
    
    with st.form("recipe_form"):
        new_name = st.text_input("æ–™ç†å")
        new_ings = st.text_input("ææ–™ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§å…¥åŠ›ï¼‰", placeholder="è±šè‚‰, ã‚­ãƒ£ãƒ™ãƒ„, åµ")
        
        c1, c2 = st.columns(2)
        new_taste = c1.slider("å‘³ã®è©•ä¾¡", 1, 5, 3)
        new_effort = c2.selectbox("æ‰‹é–“", ["æ¥½ã¡ã‚“", "æ™®é€š", "æ‰‹é–“"])
        
        c3, c4 = st.columns(2)
        new_cost = c3.selectbox("ä¾¡æ ¼æ„Ÿ", ["ç¯€ç´„", "æ™®é€š", "è´…æ²¢"])
        new_freq = c4.selectbox("é »åº¦", ["é€±1å›ä»¥ä¸Š", "æœˆ2-3å›", "æœˆ1å›", "3ãƒ¶æœˆã«1å›", "äºŒåº¦ã¨ææ¡ˆã—ãªã„"])
        
        submitted = st.form_submit_button("ç™»éŒ²ã™ã‚‹")
        
        if submitted and new_name and new_ings:
            ing_list = [x.strip() for x in new_ings.split(",")]
            new_recipe = {
                "name": new_name,
                "ingredients": ing_list,
                "taste": new_taste,
                "effort": new_effort,
                "cost": new_cost,
                "frequency": new_freq,
                "last_eaten": None
            }
            st.session_state.recipes.append(new_recipe)
            st.success(f"{new_name} ã‚’ç™»éŒ²ã—ã¾ã—ãŸï¼")
            
    st.subheader("ç™»éŒ²æ¸ˆã¿ãƒ¬ã‚·ãƒ”ä¸€è¦§")
    st.json(st.session_state.recipes)
